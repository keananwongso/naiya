import React, { useState } from 'react';
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { addMonths, subMonths, addWeeks, subWeeks, addDays, subDays } from "date-fns";
import CalendarHeader from '../components/calendar/CalendarHeader';
import MonthView from '../components/calendar/MonthView';
import WeekView from '../components/calendar/WeekView';
import DayView from '../components/calendar/DayView';
import EventModal from '../components/calendar/EventModal';
import EventDetailsPanel from '../components/calendar/EventDetailsPanel';
import { Loader2 } from 'lucide-react';

export default function Calendar() {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [view, setView] = useState('month');
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [selectedDate, setSelectedDate] = useState(null);
    const [selectedEvent, setSelectedEvent] = useState(null);
    const [isDetailsPanelOpen, setIsDetailsPanelOpen] = useState(false);

    const queryClient = useQueryClient();

    // Fetch events
    const { data: events = [], isLoading } = useQuery({
        queryKey: ['events'],
        queryFn: () => base44.entities.Event.list('-start_date'),
    });

    // Create event
    const createMutation = useMutation({
        mutationFn: (data) => base44.entities.Event.create(data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['events'] });
            setIsModalOpen(false);
            setSelectedEvent(null);
        },
    });

    // Update event
    const updateMutation = useMutation({
        mutationFn: ({ id, data }) => base44.entities.Event.update(id, data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['events'] });
            setIsModalOpen(false);
            setIsDetailsPanelOpen(false);
            setSelectedEvent(null);
        },
    });

    // Delete event
    const deleteMutation = useMutation({
        mutationFn: (id) => base44.entities.Event.delete(id),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['events'] });
            setIsDetailsPanelOpen(false);
            setSelectedEvent(null);
        },
    });

    const handleNavigate = (action) => {
        if (action === 'today') {
            setCurrentDate(new Date());
        } else if (action === 'prev') {
            if (view === 'month') setCurrentDate(subMonths(currentDate, 1));
            else if (view === 'week') setCurrentDate(subWeeks(currentDate, 1));
            else setCurrentDate(subDays(currentDate, 1));
        } else if (action === 'next') {
            if (view === 'month') setCurrentDate(addMonths(currentDate, 1));
            else if (view === 'week') setCurrentDate(addWeeks(currentDate, 1));
            else setCurrentDate(addDays(currentDate, 1));
        }
    };

    const handleCreateEvent = (date = null) => {
        setSelectedDate(date || new Date());
        setSelectedEvent(null);
        setIsModalOpen(true);
    };

    const handleEventClick = (event) => {
        setSelectedEvent(event);
        setIsDetailsPanelOpen(true);
    };

    const handleSaveEvent = (data) => {
        if (selectedEvent) {
            updateMutation.mutate({ id: selectedEvent.id, data });
        } else {
            createMutation.mutate(data);
        }
    };

    const handleEditEvent = () => {
        setIsDetailsPanelOpen(false);
        setIsModalOpen(true);
    };

    const handleDeleteEvent = () => {
        if (window.confirm('Are you sure you want to delete this event?')) {
            deleteMutation.mutate(selectedEvent.id);
        }
    };

    const handleDayClick = (day) => {
        handleCreateEvent(day);
    };

    const handleTimeSlotClick = (datetime) => {
        handleCreateEvent(datetime);
    };

    if (isLoading) {
        return (
            <div className= "min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center" >
            <Loader2 className="h-8 w-8 animate-spin text-gray-400" />
                </div>
    );
    }

    return (
        <div className= "min-h-screen bg-gradient-to-br from-gray-50 to-gray-100" >
        <div className="max-w-7xl mx-auto p-8" >
            <CalendarHeader
          currentDate={ currentDate }
    view = { view }
    onViewChange = { setView }
    onNavigate = { handleNavigate }
    onCreateEvent = {() => handleCreateEvent()
}
        />

{
    view === 'month' && (
        <MonthView
            currentDate={ currentDate }
    events = { events }
    onEventClick = { handleEventClick }
    onDayClick = { handleDayClick }
        />
        )
}

{
    view === 'week' && (
        <WeekView
            currentDate={ currentDate }
    events = { events }
    onEventClick = { handleEventClick }
    onTimeSlotClick = { handleTimeSlotClick }
        />
        )
}

{
    view === 'day' && (
        <DayView
            currentDate={ currentDate }
    events = { events }
    onEventClick = { handleEventClick }
    onTimeSlotClick = { handleTimeSlotClick }
        />
        )
}
</div>

    < EventModal
isOpen = { isModalOpen }
onClose = {() => {
    setIsModalOpen(false);
    setSelectedEvent(null);
}}
onSave = { handleSaveEvent }
selectedDate = { selectedDate }
event = { selectedEvent }
    />

    <EventDetailsPanel
        event={ selectedEvent }
isOpen = { isDetailsPanelOpen }
onClose = {() => {
    setIsDetailsPanelOpen(false);
    setSelectedEvent(null);
}}
onEdit = { handleEditEvent }
onDelete = { handleDeleteEvent }
    />
    </div>
  );
}